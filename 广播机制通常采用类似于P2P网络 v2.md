广播机制通常采用类似于P2P网络


TTL（timetolive）的减值
全分布式非结构化P2P网络 gnutella通信协议
 全分布 P2P节点可以自由加入、退出，并且没有中心节点，节点地址没有结构化统一标准，整个网络结构呈随机图的结构，无固定网络结构图。其成功的应用产品是 gnutella通信协议，它是一种点对点的搜索系统。gnutella采用的是洪泛（flooding）技术实现发现其他节点和随机转发的机制，采用 TTL（timetolive）的减值来实现控制消息通信有限次数传播。然而完全的自由意味着新节点无法得知P2P网络节点信息，从而无法加入网络。因此 gnutella使用了目录服务器来方便节点得到其他节点的网络地址。全分布式P2P网络更加自由化的同时也带来了节点管理的问题，节点频繁地加入／退出使得整个网络结构无法稳定，大量的广播消息不仅造成资源浪费，甚至会阻塞网络。中本聪设计的比特币采用的就是这种P2P网络结构，全分布式使得任何人任何节点都可以参与，非结构化使得节点间既可以通过区块链P2P协议同步区块数据，又保持匿名隐私保护，使得区块链分布式去中心化概念深入人心。
全分布式结构化P2P网络  DHT
全分布式最大的问题在于节点地址管理，节点间没有固定规则约束，无法精确定位节点信息，只能通过洪泛查询的方式进行查找，对网络的消耗很大。结构化网络采用分布式哈希表（distributedhashtable，DHT），通过如 hash函数一类的加密散列函数将不同节点地址规范为标准长度数据，比较成功的案例有 Chord、Pastry等。网络结构与非结构化相同，都是随机形式、无固定结构，但节点管理有固定结构图。以太坊将节点椭圆加密算法的公钥转换为 64 Byte的 nodeId作为唯一标志符来区分节点，使得以太坊可以在没有中心服务器的情况下实现节点地址的精确查找。
半分布式P2P网络 
结合中心化和分布式模型各自的优点，将节点分类成普通节点和超级节点，从而构成了半分布式网络结构。每个超级节点维护部分网络节点地址、文件索引等工作，超级节点共同实现中心服务器功能。超级节点本身却是分布式的，可以自由扩展退出，具备分布式网络优点，kazza是其代表性的成功应用。超级账本（fabric）采用的 P2P网络结构就是半分布式，将节点分为普通用户节点和超级节点（排序、背书节点等）。超级节点可以由普通节点选举，也可以自行配置，单独一个超级节点停机不影响系统运行。超级账本所有交易必须通过超级节点认证，区块也是由超级节点生成，普通节点间可以互相同步区块。


超级账本（fabric）采用的 P2P网络结构就是半分布式
比特币的P2P网络及节点发现
比特币开启了区块链时代，任何节点开启客户端后即可实现去中心化可信任的比特币交易。然而当一个全新的节点加入比特币网络时，首先要做的是接入网络。由于比特币完全去中心化，节点自由加入、退出导致新加入的节点无从获取网络中节点地址从而接入网络。为此，比特币设计三种节点发现方式：
ａ）种子节点。Napster采用的是中央服务器进行索引，由于中央服务器的存在，新加入节点可以稳定地接入网络。比特币虽然没有中心化服务器，但是也采用了 Napster的思路，设立“种子”节点。比特币将一部分长期稳定的节点硬编码至代码中，这些节点在初始启动时提供最初接入网络的入口节点。新节点通过这些稳定节点作为中介连接其他节点，并且可以持续获取区块链网络节点地址列表，所以这些节点也称之为种子节点。下图为比特币源码，方框中这些地址即为比特币初始化时加载的种子地址。


ｂ）地址广播。某个节点接入后，就能以这个节点为中介获取网络其他节点地址，这种方式被称为地址广播。广播包含如下两种方式：（ａ）主动广播（推）节点 Ａ地址。比特币通过 Net.AdvertiseLocal()方法，将自身节点信息推送给其他节点。如图 ４所示，这是一个主动单向过程，节点 Ｂ接收后只保存在本地，并不作回应；同样，节点 Ｂ


ｃ）地址数据库。为避免种子节点连接数及带宽限制，比特币节点接入网络后通过广播获取其他节点信息，并将结果保存，以便下次使用时接入网络。比特币客户端将获取的节点信息保存在 peers.dat本地文件中，使用的是 levelDB格式储存数据。如果节点 Ａ与已建立的连接节点 Ｂ没有数据通信，节点 Ａ会定期发送 ping消息（一个 ８bit的随机数）到节点 Ｂ；节点 Ｂ会回复 pong消息，它是一个包含 ping随机数的响应报文，用以维持连接。如果节点持续某个连接长达 20min没有任何响应，它会被认为已经从网络中断开。比特币客户端启动后会发起定时循环任务，检查连接节点是否在线，并将失败的节点保存在 banlist.dat本地文件中。
比特币通过以上三种方式保持稳定的网络接入，实现对频 繁进出节点的地址列表维护，不需要中心机构的存在即可保持 节点可以自由加入网络，从而保障比特币 P2P网络稳定。



以太坊的P2P网络及节点发现
 Kadenlia（KAD）协议，它是 DHT协议的一种

以太坊开发人员开发了一款分布式消息通信平台 Whisper和一款分布式存储平台以及内容分发服务平台 Swarm，这些应用的实现依赖于节点可以根据需要精确查找另一个节点地址的功能，而非结构化 P2P网络结构无法满足。因此以太坊采用结构化P2P网络，通过DHT技术实现结构化。DHT将 P2P网络节点通过 hash算法散列为标准长度数据，整个网络构成一个巨大的散列表。每个参与节点都有一部分的散列表，并储存维护自身数据，散列表分布在P2P网络各个节点上，任何接入 P2P网络的节点都有自身位于散列表中位置的 ID，可以通过 DHT寻找更多节点，也可以被其他节点根据 ID值精确查找。虽然 DHT支持节点自由地加入或退出，但 DHT的复杂维护机制使其无法适应高频的节点变化。以太坊使用的是 Kadenlia（KAD）协议，它是 DHT协议的一种，使用该协议可以快速准确地查找地址。



Kad介绍
与传统的 DHT比较，KAD有如下优点：
KAD的查询请求是并行、异步的，可以避免节点退出或故障导致的查询失败；
以太坊节点发现

种子节点

地址数据库 类似比特币，以太坊也采用地址数据库的形式保存连接过的节点。以太坊采用的是 LevelDB作为历史文件格式，生成多个历史数据库文件。对于首次连接以太坊网络的节点，地址数据库是空的，后续随着地址广播，逐渐填满地址列表。对于再次连接以太坊的节点，启动时以太坊使用loadSeedNodes()方法将种子节点和历史数据一起读取，快速高效地连接以太坊 P2P网络


Gossip介绍
Gossip是基于传染病感染传播机制而形成的，被广泛用于分布式系统作为底层通信协议。Gossip并非新的P2P网络思想，同传统的洪泛、路由算法相比，Gossip提供了明确的网络通信类型。Facebook开发的 cassandra使用的就是 Gossip协议，是一种流行的分布式结构化数据存储方案。Gossip在Fabric网络上负责维护新节点的发现、循环检查节点、剔除离线节点、更新节点列表。Fabric通过与节点列表中的节点广播通信，发现新的区块或本地错误及丢失的区块，更新维护本地账本数据。Gossip协议有如下三种通信类型：



１）去中心化程度 P2P网络是区块链分布式的基石，自从比特币成功以来，区块链分布式去中心化概念深入人心。传统中心金融机构所有交易必须经中央系统处理，参与节点间无法直接通信，是完全的中心化。比特币和以太坊都是完全的去中心化，所有节点权限相同，虽然有种子节点的存在，但它们在架构上和普通节点没有区别，只是相对高性能、高稳定性的节点，在去中心化上两者表现相同。Fabric则相当于分布式的中心化系统，超级节点具有中心化服务器功能，同时超级节点也是分布式集群，具有分布式特征，所以 Fabric去中心化表现介于银行类系统和比特币以太坊之间。
