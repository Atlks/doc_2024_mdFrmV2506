事务本质就是交易


3.4.7 幂等性设计
幂等性：就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。
对于账户和交易类系统，做好接口的幂等性至关重要，既是保证资金安全的利器，也是一致性补偿的必要条件。 简单来说，幂等性就是要保证同一个单号有且仅能有一次操作成功。比如使用单号deal_no1做一笔5块钱的充值，假设充值成功后重复使用该单号做充值，程序能够判断该单号已充值过，可以返回调用方已充值成功的错误码，或返回成功处理（这里采用哪种方式，取决于上层是否需要感知已充值成功这一状态）。实际无论调用充值接口多少次，总共只有1次充值5块钱成功。
保证幂等性有若干种实现方式。通用可靠的做法一般是通过DB对单号做唯一索引，依赖DB来防重保证仅能有一笔入账成功。 我的系统中也是采用这一方式，保证资金账户系统所有提供给到上层的接口都是幂等的。
3.4.8 余额流水的一致性
由于资金余额和账户流水是最为重要的两个数据，必须保证同时写入/更新成功，如果出现不一致会导致严重的资金安全后果，因此需要保证强一致。此时几乎只能利用数据库的单机事务才能保证。实际上事务这个特性最初就是被设计用来解决交易问题的，在英文中，事务和交易就是同一个单词：Transaction。
确定使用数据库的单机事务实现，又有两种解决方案：
悲观锁方案：创建资金流的时候，每次查询账户时，对该账户加排他锁。也就是在获取 accountid=1 的账户信息时对该行记录加锁，期间其他请求阻塞等待访问该记录。悲观锁适合写入频繁（写多读少）的场景。
乐观锁方案：创建资金流的时候，每次查询账户时，不对该账户加锁，而是获取到账户当前的版本号version。在更新数据的时候需要比较程序中的version与数据库中的version是否相等，如果相等则进行更新，反之程序创建资金流，再次进行比较，直到两个version的数值相等才进行数据更新。乐观锁适合读取频繁（读多写少）的场景。
在我们的系统中，由于更新账户的频率比查询账户的频率高，基于以上我选择了第一种方案

