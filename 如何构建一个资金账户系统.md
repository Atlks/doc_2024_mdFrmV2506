如何构建一个资金账户系统 | 技术创作特训营第一期
原创
修改于 2023-08-27 18:15:31
1.8K0
举报
文章被收录于专栏：软件工程师技术能力提升
资金账户是互联网和金融业务中的非常常见的系统，尤其是在电商、支付等业务中必不可少。资金账户系统本身其核心模块的整体架构往往并不复杂，但其对于资金安全和可用性的要求往往非常高，导致需要建设好一个资金账户系统并不容易。本文以笔者在微信支付境外收单中心建设过程中实现的资金账户系统为例，探讨了在资金账户系统设计和实现中会遇到的问题以及相应的解决方案。需要强调的是，笔者也是资金相关系统的入门者，本文目的是抛砖引玉，有误之处，还请大家多多指正、多多探讨、不吝指教，笔者不胜感激。
一、什么是账户
我们先看看标准定义：账户是根据会计科目设置的，具有一定格式和结构，用于反映会计要素的增减变动情况及其结果的载体。
从业务视角来看账户其实就是用于记录某个主体的某类型资金的余额以及余额变动明细的数据载体。
如果从支付这块业务来看的话，账户是支付机构内部为其服务对象（用户、商户、银行等）创建的物理记录，这些记录包含了对象的关键信息，如机构为对象分配的唯一ID、对象的余额、交易的流水、账户状态等等。 可以说账户是支付机构识别服务对象的根本，所有服务对象都必须要有账户。
综上所述，账户有3个关键的点：
账户余额：账户中的资金数目，这个账户有多少钱
账户流水：这个账户资金进进出出的明细记录，任何余额的变动都需要记录流水
交易凭证：用来记录交易过程的信息


三者主要内容包括：
1.1 余额
账户余额记录用户的资金数目，当发生交易时，会对余额进行更新操作。一般余额信息包括以下字段：
账户ID，这个ID有的平台会有编码规则，比如某些位用来区分个人或者商户，区分币种以及校验位等。
币种
余额，一般使用币种最小单位。
账户状态，比如是正常态、支付或者冻结等。
余额版本号，这个字段非常重要，体现了余额的变化过程，是与流水进行关联的关键。
1.2 流水
账户体系的目的是记账，仿佛只记录余额，对余额进行增删改查就可以了。但是这样做有两个弊端：
没有办法体现出余额变化的过程。
账户余额被篡改了没有办法追查。所以在记录余额的同时，还需要记录每一笔变化的过程，也就是账户的流水。
当余额发生变更时，需要同步记录流水，以此来跟踪余额的变化，流水信息一般包括如下内容：
流水ID
凭证ID，一般是业务单号（如订单ID、退款单ID等），也就是下面凭证中的ID。
发生金额
发生币种
起始余额
终止余额
余额版本号，与余额信息中的版本号字段对应。
资金方向，标识是入账还是出账。
源账户ID
目的账户ID
交易时间戳
总体来看，流水和余额互为冗余数据，流水不仅可以有效地减少由于内部错误导致的账户余额错误的问题，也便于账户系统与其他外部系统进行对账，所以账户系统记录流水是非常必要的。
在设计账户流水时，有几个重要的原则必须遵守：
流水记录只能新增，一旦记录成功不允许修改和删除。即使是由于正当原因需要取消一笔已经完成的交易，也不应该去删除交易流水。正确的做法是再记录一笔“取消交易”的流水。
流水中的余额版本号必须是连续递增的，我们需要用余额版本号来确定交易的先后顺序（注意：不是通过交易时间戳）。
1.3 凭证
凭证用来记录交易过程中的信息，是用户交易的依据。凭证对应到支付平台内部的各种单类，比如充值单，提现单，交易单等等。一般包括：凭证ID、交易参与方、交易金额、交易类型、交易状态（比如支付中，支付成功，转退款等）、交易渠道等信息。
凭证单理论上可以放到业务层，不放在账户核心层，这样账户层就只有余额和流水。抓住了余额、流水这两个点我们基本就抓住了资金账户系统设计的核心了。

